<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mapa con Marcadores</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body, html { margin:0; padding:0; height:100%; }
    #map { height:100%; width:100%; }

    /* Pantalla de carga semitransparente */
    #loadingScreen {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(255,255,255,0.8);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 10000;
      font-size: 22px;
      font-weight: bold;
      color: #333;
    }

    .spinner {
      border: 6px solid #f3f3f3;
      border-top: 6px solid #4CAF50;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      animation: spin 1s linear infinite;
      margin-bottom: 15px;
    }
    @keyframes spin { 0% { transform:rotate(0deg); } 100% { transform:rotate(360deg); } }

    /* Modal */
    .modal {
      position: fixed;
      top:0; left:0;
      width:100%; height:100%;
      background: rgba(0,0,0,0.7);
      display:none;
      justify-content:center;
      align-items:center;
      z-index:9999;
    }
    .modal-content {
      background:white;
      padding:20px;
      border-radius:12px;
      width:90%;
      max-width:400px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .modal-content h2 { margin:0; font-size:18px; text-align:center; }
    .modal-content input { padding:10px; border:1px solid #ccc; border-radius:6px; font-size:14px; }
    .modal-buttons { display:flex; justify-content:space-between; gap:10px; }
    .modal-buttons button { flex:1; padding:10px; border:none; border-radius:6px; font-size:14px; cursor:pointer; }
    .btn-aceptar { background:#4CAF50; color:white; }
    .btn-cancelar { background:#f44336; color:white; }

    /* Spinner overlay al guardar */
    #savingOverlay {
      position: fixed;
      top:0; left:0;
      width:100%; height:100%;
      background: rgba(255,255,255,0.8);
      display:none;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 10000;
      font-size:22px;
      font-weight:bold;
      color:#333;
    }
  </style>
</head>
<body>

<div id="loadingScreen">
  <div class="spinner"></div>
  Cargando informaciÃ³n...
</div>

<div id="map"></div>

<div class="modal" id="formModal">
  <div class="modal-content">
    <h2>Formulario</h2>
    <input type="text" id="nombre" placeholder="Nombre completo (obligatorio)" required />
    <input type="tel" id="telefono" placeholder="TelÃ©fono (obligatorio)" required />
    <input type="email" id="email" placeholder="Email (opcional)" />
    <div class="modal-buttons">
      
      <button class="btn-cancelar" onclick="cerrarModal()">Cancelar</button>
      <button class="btn-aceptar" onclick="aceptarFormulario()">Aceptar</button>
    </div>
  </div>
</div>

<div id="savingOverlay">
  <div class="spinner"></div>
  Guardando informaciÃ³n...
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
  const URL_SHEET_SAVE = "https://script.google.com/macros/s/AKfycbxlrJirTd9MHH-ZYMclyiMwvJ43-UL--iFemOCTANLx7SOHmX2xTc4jkMwW-YmAFRhUAQ/exec";
  const URL_SHEET_GET  = "https://script.google.com/macros/s/AKfycbx8oNWuXhFCQssef1gGKibvrvSfiMEh7wMFek8uLLPP5MbVctPKawutGMreSXPyp_J1ZQ/exec";

  var map = L.map('map').setView([40.22, -6.7], 11);

  var calles = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: 'Â© OpenStreetMap'
  }).addTo(map);

  var satelite = L.tileLayer(
    'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
    { attribution: 'Tiles Â© Esri' }
  );

  var topo = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
    maxZoom: 17,
    attribution: 'Map data: Â© OpenStreetMap contributors, OpenTopoMap'
  });

  L.control.layers({
    "Calles (OSM)": calles,
    "SatÃ©lite": satelite,
    "TopogrÃ¡fico": topo
  }).addTo(map);

  let tempCoords = null;

  function abrirModal(coords) {
    tempCoords = coords;
    document.getElementById("formModal").style.display = "flex";
  }

  function cerrarModal() {
    document.getElementById("formModal").style.display = "none";
    tempCoords = null;
    document.getElementById("nombre").value = "";
    document.getElementById("telefono").value = "";
    document.getElementById("email").value = "";
  }

  function validarFormulario(nombre, telefono, email) {
    if (!nombre) {
      alert("El nombre es obligatorio.");
      return false;
    }
    if (!telefono) {
      alert("El telÃ©fono es obligatorio.");
      return false;
    }
    const telRegex = /^(\+\d{1,4})?[0-9]{6,12}$/;
    if (!telRegex.test(telefono)) {
      alert("Introduce un telÃ©fono vÃ¡lido (ej. 600123456 o +34600123456 o +11234567890).");
      return false;
    }
    if (email) {
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(email)) {
        alert("Introduce un email vÃ¡lido o deja el campo vacÃ­o.");
        return false;
      }
    }
    return true;
  }

  function aceptarFormulario() {
    if (!tempCoords) return;

    var nombre = document.getElementById("nombre").value.trim();
    var telefono = document.getElementById("telefono").value.trim();
    var email = document.getElementById("email").value.trim();

    if (!validarFormulario(nombre, telefono, email)) return;

    document.getElementById("savingOverlay").style.display = "flex";

    fetch(`${URL_SHEET_SAVE}?nombre=${encodeURIComponent(nombre)}&telefono=${encodeURIComponent(telefono)}&email=${encodeURIComponent(email)}&lat=${tempCoords.lat}&lng=${tempCoords.lng}`, { method:'POST' })
      .then(res => res.json())
      .then(data => {
        document.getElementById("savingOverlay").style.display = "none";
        if (data.success) {
          L.marker([tempCoords.lat,tempCoords.lng])
            .addTo(map)
            .bindPopup(`<b>${nombre}</b><br>ðŸ“ž ${telefono}<br>ðŸ“§ ${email}`)
            .openPopup();
          cerrarModal();
        } else {
          alert("Error al guardar: " + data.message);
        }
      })
      .catch(err => {
        document.getElementById("savingOverlay").style.display = "none";
        alert("Error al guardar: " + err);
      });
  }

  map.on("click", e => abrirModal(e.latlng));

  // Cargar marcadores al iniciar
  window.addEventListener("load", () => {
    fetch(URL_SHEET_GET)
      .then(res => res.json())
      .then(data => {
        data.forEach(item => {
          if(item.lat && item.lng){
            L.marker([item.lat,item.lng])
              .addTo(map)
              .bindPopup(`<b>${item.nombre}</b><br>ðŸ“ž ${item.telefono}<br>ðŸ“§ ${item.email}`);
          }
        });
        document.getElementById("loadingScreen").style.display = "none";
      })
      .catch(err => {
        console.error(err);
        document.getElementById("loadingScreen").style.display = "none";
      });
  });
</script>
</body>
</html>
